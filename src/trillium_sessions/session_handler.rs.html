<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `sessions/src/session_handler.rs`."><title>session_handler.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-452d19225583af2a.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="trillium_sessions" data-themes="" data-resource-suffix="" data-rustdoc-version="1.77.0-nightly (fb5ed726f 2023-12-28)" data-channel="nightly" data-search-js="search-c17e98913a53b3b7.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../static.files/storage-f2adc0d6ca4d09fb.js"></script><script defer src="../../static.files/src-script-39ed315d46fb705f.js"></script><script defer src="../../src-files.js"></script><script defer src="../../static.files/main-6902632119e002ca.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-feafe1bb7466e4bd.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc src"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"></nav><div class="sidebar-resizer"></div>
    <main><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><a href="#1" id="1">1</a>
<a href="#2" id="2">2</a>
<a href="#3" id="3">3</a>
<a href="#4" id="4">4</a>
<a href="#5" id="5">5</a>
<a href="#6" id="6">6</a>
<a href="#7" id="7">7</a>
<a href="#8" id="8">8</a>
<a href="#9" id="9">9</a>
<a href="#10" id="10">10</a>
<a href="#11" id="11">11</a>
<a href="#12" id="12">12</a>
<a href="#13" id="13">13</a>
<a href="#14" id="14">14</a>
<a href="#15" id="15">15</a>
<a href="#16" id="16">16</a>
<a href="#17" id="17">17</a>
<a href="#18" id="18">18</a>
<a href="#19" id="19">19</a>
<a href="#20" id="20">20</a>
<a href="#21" id="21">21</a>
<a href="#22" id="22">22</a>
<a href="#23" id="23">23</a>
<a href="#24" id="24">24</a>
<a href="#25" id="25">25</a>
<a href="#26" id="26">26</a>
<a href="#27" id="27">27</a>
<a href="#28" id="28">28</a>
<a href="#29" id="29">29</a>
<a href="#30" id="30">30</a>
<a href="#31" id="31">31</a>
<a href="#32" id="32">32</a>
<a href="#33" id="33">33</a>
<a href="#34" id="34">34</a>
<a href="#35" id="35">35</a>
<a href="#36" id="36">36</a>
<a href="#37" id="37">37</a>
<a href="#38" id="38">38</a>
<a href="#39" id="39">39</a>
<a href="#40" id="40">40</a>
<a href="#41" id="41">41</a>
<a href="#42" id="42">42</a>
<a href="#43" id="43">43</a>
<a href="#44" id="44">44</a>
<a href="#45" id="45">45</a>
<a href="#46" id="46">46</a>
<a href="#47" id="47">47</a>
<a href="#48" id="48">48</a>
<a href="#49" id="49">49</a>
<a href="#50" id="50">50</a>
<a href="#51" id="51">51</a>
<a href="#52" id="52">52</a>
<a href="#53" id="53">53</a>
<a href="#54" id="54">54</a>
<a href="#55" id="55">55</a>
<a href="#56" id="56">56</a>
<a href="#57" id="57">57</a>
<a href="#58" id="58">58</a>
<a href="#59" id="59">59</a>
<a href="#60" id="60">60</a>
<a href="#61" id="61">61</a>
<a href="#62" id="62">62</a>
<a href="#63" id="63">63</a>
<a href="#64" id="64">64</a>
<a href="#65" id="65">65</a>
<a href="#66" id="66">66</a>
<a href="#67" id="67">67</a>
<a href="#68" id="68">68</a>
<a href="#69" id="69">69</a>
<a href="#70" id="70">70</a>
<a href="#71" id="71">71</a>
<a href="#72" id="72">72</a>
<a href="#73" id="73">73</a>
<a href="#74" id="74">74</a>
<a href="#75" id="75">75</a>
<a href="#76" id="76">76</a>
<a href="#77" id="77">77</a>
<a href="#78" id="78">78</a>
<a href="#79" id="79">79</a>
<a href="#80" id="80">80</a>
<a href="#81" id="81">81</a>
<a href="#82" id="82">82</a>
<a href="#83" id="83">83</a>
<a href="#84" id="84">84</a>
<a href="#85" id="85">85</a>
<a href="#86" id="86">86</a>
<a href="#87" id="87">87</a>
<a href="#88" id="88">88</a>
<a href="#89" id="89">89</a>
<a href="#90" id="90">90</a>
<a href="#91" id="91">91</a>
<a href="#92" id="92">92</a>
<a href="#93" id="93">93</a>
<a href="#94" id="94">94</a>
<a href="#95" id="95">95</a>
<a href="#96" id="96">96</a>
<a href="#97" id="97">97</a>
<a href="#98" id="98">98</a>
<a href="#99" id="99">99</a>
<a href="#100" id="100">100</a>
<a href="#101" id="101">101</a>
<a href="#102" id="102">102</a>
<a href="#103" id="103">103</a>
<a href="#104" id="104">104</a>
<a href="#105" id="105">105</a>
<a href="#106" id="106">106</a>
<a href="#107" id="107">107</a>
<a href="#108" id="108">108</a>
<a href="#109" id="109">109</a>
<a href="#110" id="110">110</a>
<a href="#111" id="111">111</a>
<a href="#112" id="112">112</a>
<a href="#113" id="113">113</a>
<a href="#114" id="114">114</a>
<a href="#115" id="115">115</a>
<a href="#116" id="116">116</a>
<a href="#117" id="117">117</a>
<a href="#118" id="118">118</a>
<a href="#119" id="119">119</a>
<a href="#120" id="120">120</a>
<a href="#121" id="121">121</a>
<a href="#122" id="122">122</a>
<a href="#123" id="123">123</a>
<a href="#124" id="124">124</a>
<a href="#125" id="125">125</a>
<a href="#126" id="126">126</a>
<a href="#127" id="127">127</a>
<a href="#128" id="128">128</a>
<a href="#129" id="129">129</a>
<a href="#130" id="130">130</a>
<a href="#131" id="131">131</a>
<a href="#132" id="132">132</a>
<a href="#133" id="133">133</a>
<a href="#134" id="134">134</a>
<a href="#135" id="135">135</a>
<a href="#136" id="136">136</a>
<a href="#137" id="137">137</a>
<a href="#138" id="138">138</a>
<a href="#139" id="139">139</a>
<a href="#140" id="140">140</a>
<a href="#141" id="141">141</a>
<a href="#142" id="142">142</a>
<a href="#143" id="143">143</a>
<a href="#144" id="144">144</a>
<a href="#145" id="145">145</a>
<a href="#146" id="146">146</a>
<a href="#147" id="147">147</a>
<a href="#148" id="148">148</a>
<a href="#149" id="149">149</a>
<a href="#150" id="150">150</a>
<a href="#151" id="151">151</a>
<a href="#152" id="152">152</a>
<a href="#153" id="153">153</a>
<a href="#154" id="154">154</a>
<a href="#155" id="155">155</a>
<a href="#156" id="156">156</a>
<a href="#157" id="157">157</a>
<a href="#158" id="158">158</a>
<a href="#159" id="159">159</a>
<a href="#160" id="160">160</a>
<a href="#161" id="161">161</a>
<a href="#162" id="162">162</a>
<a href="#163" id="163">163</a>
<a href="#164" id="164">164</a>
<a href="#165" id="165">165</a>
<a href="#166" id="166">166</a>
<a href="#167" id="167">167</a>
<a href="#168" id="168">168</a>
<a href="#169" id="169">169</a>
<a href="#170" id="170">170</a>
<a href="#171" id="171">171</a>
<a href="#172" id="172">172</a>
<a href="#173" id="173">173</a>
<a href="#174" id="174">174</a>
<a href="#175" id="175">175</a>
<a href="#176" id="176">176</a>
<a href="#177" id="177">177</a>
<a href="#178" id="178">178</a>
<a href="#179" id="179">179</a>
<a href="#180" id="180">180</a>
<a href="#181" id="181">181</a>
<a href="#182" id="182">182</a>
<a href="#183" id="183">183</a>
<a href="#184" id="184">184</a>
<a href="#185" id="185">185</a>
<a href="#186" id="186">186</a>
<a href="#187" id="187">187</a>
<a href="#188" id="188">188</a>
<a href="#189" id="189">189</a>
<a href="#190" id="190">190</a>
<a href="#191" id="191">191</a>
<a href="#192" id="192">192</a>
<a href="#193" id="193">193</a>
<a href="#194" id="194">194</a>
<a href="#195" id="195">195</a>
<a href="#196" id="196">196</a>
<a href="#197" id="197">197</a>
<a href="#198" id="198">198</a>
<a href="#199" id="199">199</a>
<a href="#200" id="200">200</a>
<a href="#201" id="201">201</a>
<a href="#202" id="202">202</a>
<a href="#203" id="203">203</a>
<a href="#204" id="204">204</a>
<a href="#205" id="205">205</a>
<a href="#206" id="206">206</a>
<a href="#207" id="207">207</a>
<a href="#208" id="208">208</a>
<a href="#209" id="209">209</a>
<a href="#210" id="210">210</a>
<a href="#211" id="211">211</a>
<a href="#212" id="212">212</a>
<a href="#213" id="213">213</a>
<a href="#214" id="214">214</a>
<a href="#215" id="215">215</a>
<a href="#216" id="216">216</a>
<a href="#217" id="217">217</a>
<a href="#218" id="218">218</a>
<a href="#219" id="219">219</a>
<a href="#220" id="220">220</a>
<a href="#221" id="221">221</a>
<a href="#222" id="222">222</a>
<a href="#223" id="223">223</a>
<a href="#224" id="224">224</a>
<a href="#225" id="225">225</a>
<a href="#226" id="226">226</a>
<a href="#227" id="227">227</a>
<a href="#228" id="228">228</a>
<a href="#229" id="229">229</a>
<a href="#230" id="230">230</a>
<a href="#231" id="231">231</a>
<a href="#232" id="232">232</a>
<a href="#233" id="233">233</a>
<a href="#234" id="234">234</a>
<a href="#235" id="235">235</a>
<a href="#236" id="236">236</a>
<a href="#237" id="237">237</a>
<a href="#238" id="238">238</a>
<a href="#239" id="239">239</a>
<a href="#240" id="240">240</a>
<a href="#241" id="241">241</a>
<a href="#242" id="242">242</a>
<a href="#243" id="243">243</a>
<a href="#244" id="244">244</a>
<a href="#245" id="245">245</a>
<a href="#246" id="246">246</a>
<a href="#247" id="247">247</a>
<a href="#248" id="248">248</a>
<a href="#249" id="249">249</a>
<a href="#250" id="250">250</a>
<a href="#251" id="251">251</a>
<a href="#252" id="252">252</a>
<a href="#253" id="253">253</a>
<a href="#254" id="254">254</a>
<a href="#255" id="255">255</a>
<a href="#256" id="256">256</a>
<a href="#257" id="257">257</a>
<a href="#258" id="258">258</a>
<a href="#259" id="259">259</a>
<a href="#260" id="260">260</a>
<a href="#261" id="261">261</a>
<a href="#262" id="262">262</a>
<a href="#263" id="263">263</a>
<a href="#264" id="264">264</a>
<a href="#265" id="265">265</a>
<a href="#266" id="266">266</a>
<a href="#267" id="267">267</a>
<a href="#268" id="268">268</a>
<a href="#269" id="269">269</a>
<a href="#270" id="270">270</a>
<a href="#271" id="271">271</a>
<a href="#272" id="272">272</a>
<a href="#273" id="273">273</a>
<a href="#274" id="274">274</a>
<a href="#275" id="275">275</a>
<a href="#276" id="276">276</a>
<a href="#277" id="277">277</a>
<a href="#278" id="278">278</a>
<a href="#279" id="279">279</a>
<a href="#280" id="280">280</a>
<a href="#281" id="281">281</a>
<a href="#282" id="282">282</a>
<a href="#283" id="283">283</a>
<a href="#284" id="284">284</a>
<a href="#285" id="285">285</a>
<a href="#286" id="286">286</a>
<a href="#287" id="287">287</a>
<a href="#288" id="288">288</a>
<a href="#289" id="289">289</a>
<a href="#290" id="290">290</a>
<a href="#291" id="291">291</a>
<a href="#292" id="292">292</a>
<a href="#293" id="293">293</a>
<a href="#294" id="294">294</a>
<a href="#295" id="295">295</a>
<a href="#296" id="296">296</a>
<a href="#297" id="297">297</a>
<a href="#298" id="298">298</a>
<a href="#299" id="299">299</a>
<a href="#300" id="300">300</a>
<a href="#301" id="301">301</a>
<a href="#302" id="302">302</a>
<a href="#303" id="303">303</a>
<a href="#304" id="304">304</a>
<a href="#305" id="305">305</a>
<a href="#306" id="306">306</a>
<a href="#307" id="307">307</a>
<a href="#308" id="308">308</a>
<a href="#309" id="309">309</a>
<a href="#310" id="310">310</a>
<a href="#311" id="311">311</a>
<a href="#312" id="312">312</a>
<a href="#313" id="313">313</a>
<a href="#314" id="314">314</a>
<a href="#315" id="315">315</a>
<a href="#316" id="316">316</a>
<a href="#317" id="317">317</a>
<a href="#318" id="318">318</a>
<a href="#319" id="319">319</a>
<a href="#320" id="320">320</a>
<a href="#321" id="321">321</a>
<a href="#322" id="322">322</a>
<a href="#323" id="323">323</a>
<a href="#324" id="324">324</a>
<a href="#325" id="325">325</a>
<a href="#326" id="326">326</a>
<a href="#327" id="327">327</a>
<a href="#328" id="328">328</a>
</pre></div><pre class="rust"><code><span class="kw">const </span>BASE64_DIGEST_LEN: usize = <span class="number">44</span>;
<span class="kw">use </span>async_session::{
    base64,
    hmac::{Hmac, Mac, NewMac},
    sha2::Sha256,
    Session, SessionStore,
};
<span class="kw">use </span>std::{
    fmt::{<span class="self">self</span>, Debug, Formatter},
    iter,
    time::{Duration, SystemTime},
};
<span class="kw">use </span>trillium::{async_trait, Conn, Handler};
<span class="kw">use </span>trillium_cookies::{
    cookie::{Cookie, Key, SameSite},
    CookiesConnExt,
};

<span class="doccomment">/**
# Handler to enable sessions.

See crate-level docs for an overview of this crate's approach to
sessions and security.
*/

</span><span class="kw">pub struct </span>SessionHandler&lt;Store&gt; {
    store: Store,
    cookie_path: String,
    cookie_name: String,
    cookie_domain: <span class="prelude-ty">Option</span>&lt;String&gt;,
    session_ttl: <span class="prelude-ty">Option</span>&lt;Duration&gt;,
    save_unchanged: bool,
    same_site_policy: SameSite,
    key: Key,
    older_keys: Vec&lt;Key&gt;,
}

<span class="kw">impl</span>&lt;Store: SessionStore&gt; Debug <span class="kw">for </span>SessionHandler&lt;Store&gt; {
    <span class="kw">fn </span>fmt(<span class="kw-2">&amp;</span><span class="self">self</span>, f: <span class="kw-2">&amp;mut </span>Formatter&lt;<span class="lifetime">'_</span>&gt;) -&gt; fmt::Result {
        f.debug_struct(<span class="string">"SessionHandler"</span>)
            .field(<span class="string">"store"</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.store)
            .field(<span class="string">"cookie_path"</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.cookie_path)
            .field(<span class="string">"cookie_name"</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.cookie_name)
            .field(<span class="string">"cookie_domain"</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.cookie_domain)
            .field(<span class="string">"session_ttl"</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.session_ttl)
            .field(<span class="string">"save_unchanged"</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.save_unchanged)
            .field(<span class="string">"same_site_policy"</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.same_site_policy)
            .field(<span class="string">"key"</span>, <span class="kw-2">&amp;</span><span class="string">"&lt;&lt;secret&gt;&gt;"</span>)
            .field(<span class="string">"older_keys"</span>, <span class="kw-2">&amp;</span><span class="string">"&lt;&lt;secret&gt;&gt;"</span>)
            .finish()
    }
}

<span class="kw">impl</span>&lt;Store: SessionStore&gt; SessionHandler&lt;Store&gt; {
    <span class="doccomment">/**
    Constructs a SessionHandler from the given
    [`async_session::SessionStore`] and secret. The `secret` MUST be
    at least 32 bytes long, and MUST be cryptographically random to be
    secure. It is recommended to retrieve this at runtime from the
    environment instead of compiling it into your application.

    # Panics

    SessionHandler::new will panic if the secret is fewer than
    32 bytes.

    # Defaults

    The defaults for SessionHandler are:
    * cookie path: "/"
    * cookie name: "trillium.sid"
    * session ttl: one day
    * same site: strict
    * save unchanged: enabled
    * older secrets: none

    # Customization

    Although the above defaults are appropriate for most applications,
    they can be overridden. Please be careful changing these settings,
    as they can weaken your application's security:

    ```rust
    # use std::time::Duration;
    # use trillium_sessions::{SessionHandler, MemoryStore};
    # use trillium_cookies::{CookiesHandler, cookie::SameSite};
    # std::env::set_var("TRILLIUM_SESSION_SECRETS", "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb");
    // this logic will be unique to your deployment
    let secrets_var = std::env::var("TRILLIUM_SESSION_SECRETS").unwrap();
    let session_secrets = secrets_var.split(' ').collect::&lt;Vec&lt;_&gt;&gt;();

    let handler = (
        CookiesHandler::new(),
        SessionHandler::new(MemoryStore::new(), session_secrets[0])
            .with_cookie_name("custom.cookie.name")
            .with_cookie_path("/some/path")
            .with_cookie_domain("trillium.rs")
            .with_same_site_policy(SameSite::Strict)
            .with_session_ttl(Some(Duration::from_secs(1)))
            .with_older_secrets(&amp;session_secrets[1..])
            .without_save_unchanged()
    );

    ```
    */
    </span><span class="kw">pub fn </span>new(store: Store, secret: <span class="kw">impl </span>AsRef&lt;[u8]&gt;) -&gt; <span class="self">Self </span>{
        <span class="self">Self </span>{
            store,
            save_unchanged: <span class="bool-val">true</span>,
            cookie_path: <span class="string">"/"</span>.into(),
            cookie_name: <span class="string">"trillium.sid"</span>.into(),
            cookie_domain: <span class="prelude-val">None</span>,
            same_site_policy: SameSite::Lax,
            session_ttl: <span class="prelude-val">Some</span>(Duration::from_secs(<span class="number">24 </span>* <span class="number">60 </span>* <span class="number">60</span>)),
            key: Key::derive_from(secret.as_ref()),
            older_keys: <span class="macro">vec!</span>[],
        }
    }

    <span class="doccomment">/// Sets a cookie path for this session handler.
    /// The default for this value is "/"
    </span><span class="kw">pub fn </span>with_cookie_path(<span class="kw-2">mut </span><span class="self">self</span>, cookie_path: <span class="kw">impl </span>AsRef&lt;str&gt;) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.cookie_path = cookie_path.as_ref().to_owned();
        <span class="self">self
    </span>}

    <span class="doccomment">/// Sets a session ttl. This will be used both for the cookie
    /// expiry and also for the session-internal expiry.
    ///
    /// The default for this value is one day. Set this to None to not
    /// set a cookie or session expiry. This is not recommended.
    </span><span class="kw">pub fn </span>with_session_ttl(<span class="kw-2">mut </span><span class="self">self</span>, session_ttl: <span class="prelude-ty">Option</span>&lt;Duration&gt;) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.session_ttl = session_ttl;
        <span class="self">self
    </span>}

    <span class="doccomment">/// Sets the name of the cookie that the session is stored with or in.
    ///
    /// If you are running multiple trillium applications on the same
    /// domain, you will need different values for each
    /// application. The default value is "trillium.sid"
    </span><span class="kw">pub fn </span>with_cookie_name(<span class="kw-2">mut </span><span class="self">self</span>, cookie_name: <span class="kw">impl </span>AsRef&lt;str&gt;) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.cookie_name = cookie_name.as_ref().to_owned();
        <span class="self">self
    </span>}

    <span class="doccomment">/// Disables the `save_unchanged` setting. When `save_unchanged`
    /// is enabled, a session will cookie will always be set. With
    /// `save_unchanged` disabled, the session data must be modified
    /// from the `Default` value in order for it to save. If a session
    /// already exists and its data unmodified in the course of a
    /// request, the session will only be persisted if
    /// `save_unchanged` is enabled.
    </span><span class="kw">pub fn </span>without_save_unchanged(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.save_unchanged = <span class="bool-val">false</span>;
        <span class="self">self
    </span>}

    <span class="doccomment">/// Sets the same site policy for the session cookie. Defaults to
    /// SameSite::Strict. See [incrementally better
    /// cookies](https://tools.ietf.org/html/draft-west-cookie-incrementalism-01)
    /// for more information about this setting
    </span><span class="kw">pub fn </span>with_same_site_policy(<span class="kw-2">mut </span><span class="self">self</span>, policy: SameSite) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.same_site_policy = policy;
        <span class="self">self
    </span>}

    <span class="doccomment">/// Sets the domain of the cookie.
    </span><span class="kw">pub fn </span>with_cookie_domain(<span class="kw-2">mut </span><span class="self">self</span>, cookie_domain: <span class="kw">impl </span>AsRef&lt;str&gt;) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.cookie_domain = <span class="prelude-val">Some</span>(cookie_domain.as_ref().to_owned());
        <span class="self">self
    </span>}

    <span class="doccomment">/// Sets optional older signing keys that will not be used to sign
    /// cookies, but can be used to validate previously signed
    /// cookies.
    </span><span class="kw">pub fn </span>with_older_secrets(<span class="kw-2">mut </span><span class="self">self</span>, secrets: <span class="kw-2">&amp;</span>[<span class="kw">impl </span>AsRef&lt;[u8]&gt;]) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.older_keys = secrets
            .iter()
            .map(AsRef::as_ref)
            .map(Key::derive_from)
            .collect();
        <span class="self">self
    </span>}

    <span class="comment">//--- methods below here are private ---

    </span><span class="kw">async fn </span>load_or_create(<span class="kw-2">&amp;</span><span class="self">self</span>, cookie_value: <span class="prelude-ty">Option</span>&lt;<span class="kw-2">&amp;</span>str&gt;) -&gt; Session {
        <span class="kw">let </span>session = <span class="kw">match </span>cookie_value {
            <span class="prelude-val">Some</span>(cookie_value) =&gt; <span class="self">self
                </span>.store
                .load_session(String::from(cookie_value))
                .<span class="kw">await
                </span>.ok()
                .flatten(),
            <span class="prelude-val">None </span>=&gt; <span class="prelude-val">None</span>,
        };

        session
            .and_then(|session| session.validate())
            .unwrap_or_default()
    }

    <span class="kw">fn </span>build_cookie(<span class="kw-2">&amp;</span><span class="self">self</span>, secure: bool, cookie_value: String) -&gt; Cookie&lt;<span class="lifetime">'static</span>&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>cookie: Cookie&lt;<span class="lifetime">'static</span>&gt; = Cookie::build((<span class="self">self</span>.cookie_name.clone(), cookie_value))
            .http_only(<span class="bool-val">true</span>)
            .same_site(<span class="self">self</span>.same_site_policy)
            .secure(secure)
            .path(<span class="self">self</span>.cookie_path.clone())
            .into();

        <span class="kw">if let </span><span class="prelude-val">Some</span>(ttl) = <span class="self">self</span>.session_ttl {
            cookie.set_expires(<span class="prelude-val">Some</span>((SystemTime::now() + ttl).into()));
        }

        <span class="kw">if let </span><span class="prelude-val">Some</span>(cookie_domain) = <span class="self">self</span>.cookie_domain.clone() {
            cookie.set_domain(cookie_domain)
        }

        <span class="self">self</span>.sign_cookie(<span class="kw-2">&amp;mut </span>cookie);

        cookie
    }
    <span class="comment">// the following is reused verbatim from
    // https://github.com/SergioBenitez/cookie-rs/blob/master/src/secure/signed.rs#L37-46
    </span><span class="doccomment">/// Signs the cookie's value providing integrity and authenticity.
    </span><span class="kw">fn </span>sign_cookie(<span class="kw-2">&amp;</span><span class="self">self</span>, cookie: <span class="kw-2">&amp;mut </span>Cookie&lt;<span class="lifetime">'_</span>&gt;) {
        <span class="comment">// Compute HMAC-SHA256 of the cookie's value.
        </span><span class="kw">let </span><span class="kw-2">mut </span>mac = Hmac::&lt;Sha256&gt;::new_from_slice(<span class="self">self</span>.key.signing()).expect(<span class="string">"good key"</span>);
        mac.update(cookie.value().as_bytes());

        <span class="comment">// Cookie's new value is [MAC | original-value].
        </span><span class="kw">let </span><span class="kw-2">mut </span>new_value = base64::encode(mac.finalize().into_bytes());
        new_value.push_str(cookie.value());
        cookie.set_value(new_value);
    }

    <span class="comment">// the following is reused verbatim from
    // https://github.com/SergioBenitez/cookie-rs/blob/master/src/secure/signed.rs#L51-L66
    </span><span class="doccomment">/// Given a signed value `str` where the signature is prepended to `value`,
    /// verifies the signed value and returns it. If there's a problem, returns
    /// an `Err` with a string describing the issue.
    </span><span class="kw">fn </span>verify_signature&lt;<span class="lifetime">'a</span>&gt;(<span class="kw-2">&amp;</span><span class="self">self</span>, cookie_value: <span class="kw-2">&amp;</span><span class="lifetime">'a </span>str) -&gt; <span class="prelude-ty">Option</span>&lt;<span class="kw-2">&amp;</span><span class="lifetime">'a </span>str&gt; {
        <span class="kw">if </span>cookie_value.len() &lt; BASE64_DIGEST_LEN {
            <span class="macro">log::trace!</span>(<span class="string">"length of value is &lt;= BASE64_DIGEST_LEN"</span>);
            <span class="kw">return </span><span class="prelude-val">None</span>;
        }

        <span class="comment">// Split [MAC | original-value] into its two parts.
        </span><span class="kw">let </span>(digest_str, value) = cookie_value.split_at(BASE64_DIGEST_LEN);
        <span class="kw">let </span>digest = <span class="kw">match </span>base64::decode(digest_str) {
            <span class="prelude-val">Ok</span>(digest) =&gt; digest,
            <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; {
                <span class="macro">log::trace!</span>(<span class="string">"bad base64 digest"</span>);
                <span class="kw">return </span><span class="prelude-val">None</span>;
            }
        };

        iter::once(<span class="kw-2">&amp;</span><span class="self">self</span>.key)
            .chain(<span class="self">self</span>.older_keys.iter())
            .find_map(|key| {
                <span class="kw">let </span><span class="kw-2">mut </span>mac = Hmac::&lt;Sha256&gt;::new_from_slice(key.signing()).expect(<span class="string">"good key"</span>);
                mac.update(value.as_bytes());
                mac.verify(<span class="kw-2">&amp;</span>digest).ok()
            })
            .map(|<span class="kw">_</span>| value)
    }
}

<span class="attr">#[async_trait]
</span><span class="kw">impl</span>&lt;Store: SessionStore&gt; Handler <span class="kw">for </span>SessionHandler&lt;Store&gt; {
    <span class="kw">async fn </span>run(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="kw-2">mut </span>conn: Conn) -&gt; Conn {
        <span class="kw">let </span>session = conn.take_state::&lt;Session&gt;();

        <span class="kw">let </span>cookie_value = conn
            .cookies()
            .get(<span class="kw-2">&amp;</span><span class="self">self</span>.cookie_name)
            .and_then(|cookie| <span class="self">self</span>.verify_signature(cookie.value()));

        <span class="kw">let </span><span class="kw-2">mut </span>session = <span class="kw">match </span>session {
            <span class="prelude-val">Some</span>(session) =&gt; session,
            <span class="prelude-val">None </span>=&gt; <span class="self">self</span>.load_or_create(cookie_value).<span class="kw">await</span>,
        };

        <span class="kw">if let </span><span class="prelude-val">Some</span>(ttl) = <span class="self">self</span>.session_ttl {
            session.expire_in(ttl);
        }

        conn.with_state(session)
    }

    <span class="kw">async fn </span>before_send(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="kw-2">mut </span>conn: Conn) -&gt; Conn {
        <span class="kw">if let </span><span class="prelude-val">Some</span>(session) = conn.take_state::&lt;Session&gt;() {
            <span class="kw">let </span>session_to_keep = session.clone();
            <span class="kw">let </span>secure = conn.is_secure();
            <span class="kw">if </span>session.is_destroyed() {
                <span class="self">self</span>.store.destroy_session(session).<span class="kw">await</span>.ok();
                conn.cookies_mut()
                    .remove(Cookie::from(<span class="self">self</span>.cookie_name.clone()));
            } <span class="kw">else if </span><span class="self">self</span>.save_unchanged || session.data_changed() {
                <span class="kw">match </span><span class="self">self</span>.store.store_session(session).<span class="kw">await </span>{
                    <span class="prelude-val">Ok</span>(<span class="prelude-val">Some</span>(cookie_value)) =&gt; {
                        conn.cookies_mut()
                            .add(<span class="self">self</span>.build_cookie(secure, cookie_value));
                    }

                    <span class="prelude-val">Ok</span>(<span class="prelude-val">None</span>) =&gt; {}

                    <span class="prelude-val">Err</span>(e) =&gt; {
                        <span class="macro">log::error!</span>(<span class="string">"could not store session:\n\n{e}"</span>)
                    }
                }
            }

            conn.with_state(session_to_keep)
        } <span class="kw">else </span>{
            conn
        }
    }
}

<span class="doccomment">/// Alias for [`SessionHandler::new`]
</span><span class="kw">pub fn </span>sessions&lt;Store&gt;(store: Store, secret: <span class="kw">impl </span>AsRef&lt;[u8]&gt;) -&gt; SessionHandler&lt;Store&gt;
<span class="kw">where
    </span>Store: SessionStore,
{
    SessionHandler::new(store, secret)
}
</code></pre></div></section></main></body></html>